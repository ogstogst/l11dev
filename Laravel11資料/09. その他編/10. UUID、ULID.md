UUID / ULID とは、一意性を保つために設計された文字列の ID で、重複する恐れは天文学的に低いので、安心して使用できる ID となります。
UUID は、128ビットの識別子ですが、16進法による文字列による表現が使われる事が多く、一方、ULID は、26文字のエンコードされた文字で表現されます。

```
UUID（Ver.4）
ca004cbd-a728-4232-90db-d9a2a31d3c80

UUID（Ver.7）
0183601f-527f-7b88-9c2e-09bc7cb91ce1

ULID
01GDFVRZW5YKKGDFTFQCM6BDF5
```

また、UUID は、RFC 4122 で規格化されているのに対し、ULID は、コミュニティ（草の根）的な規格です。

## バージョンによる違い等
UUID には、バージョンがあり、現在はまだ Ver.4 が主流と言えます。ちなみに、UUID を `-` で区切った時の3つ目の先頭の数字が、UUID のバージョンを示しています。

UUID Ver.4 は、一部を除けば、**完全ランダム**な値になっています（＝時系列でソート不可）。
UUID Ver.7 は、先頭にタイムスタンプ情報を持つことにより、時系列で**ソート可能**な ID が生成されるようになっています。
ULID は、先頭48ビットにタイムスタンプを置くことにより、時系列で**ソート可能**となっています。

Laravel では、UUID Ver.7 を扱う事もできますが、デフォルト対応では、Ver.4 となります。

## Laravel における UUID
上記でも記した通り、Laravel で UUID を使う時は、Ver.4 がデフォルトになります。但し、Laravel の UUID Ver.4 は、少し独自仕様が加わっていて、完全にランダムではなく、時系列でソート可能な UUID となっています。

## Laravel での UUID / ULID のサポート
Laravel では、UUID / ULID の文字列を生成するには、以下のような記述をする事で簡単に生成できます。

```php
use Illuminate\Support\Str;

$uuid = (string) Str::uuid();
$ulid = (string) Str::ulid();
```

ですが、Laravel においては通常、このような手動な対応はしなくても良いようにできています。

## UUID を使って見る
### DB に UUID / ULID の項目を作成する
UUID / ULID 用のマイグレーション定義メソッドも存在します。通常の `id` に変わる形で UUID / ULID を作成することも可能ではありますが、ここでは通常の `id` 列とは別で、UUID 列を作成します。（以降は、UUID で話を進めます。ULID の場合は、メソッド名が `ulid` と変わります）

例えば、以下のような定義になります。

```php
    public function up(): void
    {
        Schema::create('posts', function (Blueprint $table) {
            $table->id();
            $table->foreignId('user_id')->constrained();
            $table->uuid('uuid')->index();   // ★ ここです
            // 以下、略
        });
```

MySQL では、`char(36)` 型で作成されます。

### Factory と Faker の設定
以下のように設定します。

```php
class PostFactory extends Factory
{
    public function definition(): array
    {
        return [
            'user_id' => User::factory(),
            'uuid' => (string) fake()->uuid(),  // ★ ここです
            'title' => fake()->realText(20),
            'body' => fake()->realText(50),
        ];
    }
```

2024年4月現在、上記では、UUID Ver.3 で生成されます。対応する ULID 用メソッド `fake()->ulid()` は、残念ながらありませんが、`Str::ulid()` で代用できます。

### モデル側での設定
Laravel で用意されたトレイトを読み込むことにより、DB にデータを保存する際に、自動で UUID が発行（登録）されるようになります。以下のようにします。

Post.php
```php
use Illuminate\Database\Eloquent\Concerns\HasUuids;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Post extends Model
{
    use HasFactory;
    use HasUuids;

    public function uniqueIds()
    {
        return ['uuid']; // 項目名を指定する
    }
}
```

ULID の場合は、`HasUlids` というトレイトになります。

ドキュメント：[本家サイト](https://laravel.com/docs/11.x/eloquent#uuid-and-ulid-keys) [日本語](https://readouble.com/laravel/11.x/ja/eloquent.html#uuid-and-ulid-keys)

### 動作確認
以上で基本的な動作確認の準備はできました。実際に Post データを保存する際に、自動で UUID も発行されるか確認してみましょう。

web.php
```php
use App\Models\Post;
use App\Models\User;

Route::get('uuid', function () {
    $user = User::first();

    $post = new Post;
    $post->title = 'title';
    $post->body = 'body';
    $post->user_id = $user->id;
    $post->save();

    dd($post->toArray());
});
```

### ルートモデル結合
ルートモデル結合も簡単にできます。以下になります。

web.php
```php
Route::get('uuid/{post:uuid}', function (Post $post) {
    dd($post->toArray());
});
```

`:uuid` を付け加え、検索に使用するキーを指定します。
なお、上記で Laravel のトレイトを使っている場合、実際に UUID の形式をしているか Laravel が自動でチェックをし、チェックを通った時のみ、データベースに問い合わせる処理をしています。

グローバルに `uuid` の項目をルートモデル結合のキーとしたい時は、モデルファイルに以下のように記述します。

Models/Post.php
```php
    public function getRouteKeyName(): string
    {
        return 'uuid';
    }
```

これで上記の `'uuid/{post:uuid}'` と記述した箇所は、`'uuid/{post}'` とだけ書けば大丈夫になります。また、CRUD で作成した一式についても UUID での対応がされました。