Laravel におけるコレクション型とは、PHP の配列を元にして、機能を追加＆拡張した独自のものです。PHP と機能が被るものもあるけど、PHP のそれよりも使い易いです。
コレクション用のメソッドを使う事により、簡潔に書けるのはもちろん、何をしようとしているかが、より明確になります。

#### 普通のコレクション型
ドキュメント：[本家サイト](https://laravel.com/docs/11.x/collections) [日本語](https://readouble.com/laravel/11.x/ja/collections.html)

#### Eloquent モデル用のコレクション型
ドキュメント：[本家サイト](https://laravel.com/docs/11.x/eloquent-collections) [日本語](https://readouble.com/laravel/11.x/ja/eloquent-collections.html)

Eloquent 用のコレクションは、普通のコレクションを元にしているが、Eloquent 用にメソッドを多少追加＆改良したもの。Eloquent モデル経由で DB からデータを取得したものは、このコレクション型になっています。（普通のコレクション型に存在するメソッドは、Eloquent 用のコレクションでも使えます）

### collect ヘルパー関数
普通の配列をコレクション型に変換する `collect` ヘルパ関数というものもあります。

```php
$names = ['taro', 'jiro', 'saburo'];

$collection = collect($names);
```

##  厳選、コレクションメソッド
以下の厳選メソッドを見ていきます。
each, map, filter, reject, unique, reduce, pluck, find, get, first, where, contains, implode、all, values

### each
最も汎用的なメソッド。（特定の用途には特化していないメソッド）
各要素に対して、何かのアクションをする時などにいい。

```php
$users = User::get();

$users->each(function ($user, $i) {
    $user->update(['name' => '名前'.$i]);
});
```

### map
既存の配列 or コレクション（以下、配列等と呼ぶ）から何かデータを加工して、新しい配列を作成する際に利用する。（新しい配列にマッピングする）
最終的な配列の数は変わらない。

例：各名前の配列に「さん」を付加した配列を作る。
```php
$names = ['taro', 'jiro', 'saburo'];

$newNames = collect($names)->map(function ($name) {
    return $name.'さん';
})->all();

// ->all() でコレクション型から普通の配列になります
dump($newNames); // ['taroさん', 'jiroさん', 'saburoさん']
```

### filter
何かの条件でもって、既存の配列等から特定の要素のみ抜き出す。（要は、フィルタリング）
（引数を付けなければ、単に falsy 以外の要素のみ抜き出します）

例：引数を付けないタイプ
```php
$nums = collect([1, 2, 3, null, false, '', 0, []])->filter()->all();

dump($nums); // [1, 2, 3]
```

例：引数でコールバック関数を使用
```php
$names = ['taro', 'jiro', 'saburo'];

$newNames = collect($names)
    ->filter(function ($name) {
        return $name === 'jiro';  // jiroさんのみ抽出
    })
    ->map(function ($name) {
        return $name.'さん';
    })->all();

dump($newNames); // ['jiroさん']
```
### reject
filterの逆のメソッド。

### unique
重複している値を取り除きます。

### reduce
配列等の各要素を利用して行き、少しずつ形を変え、最終的に1つの値を返す。
（第2引数を利用し、初期値を設定することができる）

例：所持金100円から、10円、20円、30円とお金を増やした時、最終的に何円になるか計算。
```php
$sum = collect([10, 20, 30])
    ->reduce(function ($carry, $item) {
        return $carry + $item;
    }, 100);

dump($sum); // 160
```

「合計値」を求めるだけであれば、`->sum()` という専用のメソッドもあります。

### pluck
指定の項目を抜き出すのに使えます。

例：ユーザー一覧から、メールアドレス一覧を取得する。
```php
$users = User::get();

$emails = $users->pluck('email')->all();

dump($emails); // ['メルアド', 'メルアド']
```

#### 余談ですが、、
上記は、ユーザーの一覧（取得済みデータ）からメールアドレス一覧を作成しています。
一方、下記の場合は、SQL 的に最初からメールアドレスのみを取得します。

```php
$emails = User::pluck('email')->all(); // 「SELECT `email` FROM `users`」の SQL が発行される

dump($emails); // ['メルアド', 'メルアド']
```

例えば他にも、全 DB 内のユーザー数をカウントする場合などでは、SQL 的にカウントすると無駄がありません。
```php
$cnt = User::count(); // SQL 的にカウント
$cnt = User::get()->count(); // 全件データを取得してからカウント（効率が悪い…）
```

### find
Eloquent Collection のみで使えます。
連番を指定して、そのデータを取得できます。（無ければ、null）

```php
$users = User::get();

$user = $users->find(1);

dump($user->id); // 1
```

### get
find に似ているが、こちらは指定の要素番号の要素を得る

```php
$users = User::get();

$user = $users->get(0);

dump($user->id); // 1
```

### first
引数無しで、単純に最初の要素を取得する。引数に callback 関数を書けば条件を指定できる。

```php
$first = collect([1, 2, 3, 4])->first(function ($value, $key) {
    return $value > 2;
});

dump($first); // 3
```

### where
キーと値を指定して、データを抽出するのに利用できます。whereFirst なども便利です。

```php
$products = $collection = collect([
    ['product' => 'Desk', 'price' => 200],
    ['product' => 'Chair', 'price' => 100],
    ['product' => 'Bookcase', 'price' => 150],
    ['product' => 'Door', 'price' => 100],
])
    ->where('price', 100)
    ->all();

dump($products);
/*
    [
        ['product' => 'Chair', 'price' => 100],
        ['product' => 'Door', 'price' => 100],
    ]
*/
```

### contains
配列等に特定のデータが含まれるかをチェックする際に利用できます。
Eloquent Collection では、幾らか機能が拡張がされており、それらは利用価値が高いです。

```php
$users->contains(1); // id が 1 のモデルを含むか
$users->contains($user); // $user を含むか
$users->contains('name', 'taro'); // 指定のキーと値のデータを含むか（Eloquentでなくても利用可）
```

### implode
指定の文字列で配列等を結合します。

```php
$names = ['太郎', '次郎', '花子'];

$allName = collect($names)->implode('、');

dd($allName); // 「太郎、次郎、花子」
```

### all
コレクション型を通常の配列に変換します。
同じ目的で、`->toArray()` もありますが、`->toArray()` の場合は、データを再帰的に配列にします。

### values
`->filter()` や `->reject()` 等してデータの数が変わった場合、添え字を振り直してくれます。
`->all()` や `->toArray()` の直前に入れる事が多いです。

```php
$names = ['太郎', '次郎', '権兵衛', '花子'];

$names = collect($names)
    ->reject(function ($name) {
        return $name === '権兵衛';
    })
    ->values()
    ->all();

dd($names);

array:3 [
  0 => "太郎"
  1 => "次郎"
  2 => "花子"
]

// values() を入れない場合
array:3 [
  0 => "太郎"
  1 => "次郎"
  3 => "花子"
]
```

## その他
コレクションとはまた別に、単なる配列のヘルパー関数というのもあります。
ドキュメント：[本家サイト](https://laravel.com/docs/11.x/helpers) [日本語](https://readouble.com/laravel/11.x/ja/helpers.html)
