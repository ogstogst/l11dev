ドキュメント：[本家サイト](https://laravel.com/docs/11.x/logging) [日本語](https://readouble.com/laravel/11.x/ja/logging.html)

アプリケーション内で起きている事象をログに取ることができます。デフォルトでは、システムエラー発生時にログが取られますが、必要に応じて slack に送信するなどカスタマイズすることができます。以下が設定ファイルです。

config/logging.php
```php
return [

    'default' => env('LOG_CHANNEL', 'stack'),

    'deprecations' => [
        'channel' => env('LOG_DEPRECATIONS_CHANNEL', 'null'),
        'trace' => env('LOG_DEPRECATIONS_TRACE', false),
    ],

    'channels' => [
        'stack' => [
            'driver' => 'stack',
            'channels' => explode(',', env('LOG_STACK', 'single')),
            'ignore_exceptions' => false,
        ],

        'single' => [
            'driver' => 'single',
            'path' => storage_path('logs/laravel.log'),
            'level' => env('LOG_LEVEL', 'debug'),
            'replace_placeholders' => true,
        ],

        'daily' => [
            'driver' => 'daily',
            'path' => storage_path('logs/laravel.log'),
            'level' => env('LOG_LEVEL', 'debug'),
            'days' => env('LOG_DAILY_DAYS', 14),
            'replace_placeholders' => true,
        ],
    ... 他、続く
```

ログを取る際は、「チャンネル名」を指定してログを取ります。デフォルトでは、`stack` となっています。`stack` は少し特別なチャンネルで、他の複数のチャンネルを指定することができます。デフォルトでは、`single` のみが指定されています。`single` は、1つのファイルにログを溜めていきます。`daily` は、日にちごとにローテーションされ、`days` で指定した日数分、ログを保持します。

自分でカスタマイズしたチャンネルを記載することもできます。
```php
return [
    'channels' => [
        'login' => [
            'driver' => 'daily',
            'path' => storage_path('logs/login.log'),
            'level' => 'debug',
            'days' => 90,
        ],
```

## ログのレベル
各ログには、ログのレベルという概念があります。チャンネルに送られて来たログを、実際に処理するかどうかは、そのログのレベルに依ります。ログのレベルは、重要度順に以下があります。
`emergency` `alert` `critical` `error` `warning` `notice` `info` `debug`

例えば、`'level' => 'alert',` となっていれば、それは、`alert` レベル以上のもののみログを取ります。ログレベルは、サーバ環境に応じて、適宜変更すると良いでしょう。（例：本番サーバでは、`info`、開発サーバでは、`debug` 等）

## ログの取り方
エラーなどが起きた際に、フレームワークが自動で送るログとは別に、アプリ側でもログを送信する事ができます。幾つかバリデーションがありますが、以下がログを取る方法になります。

Log ファサードを使った場合
```php
use Illuminate\Support\Facades\Log;

// デフォルトのチャンネルにログを送る場合
Log::emergency($message);
Log::alert($message);
Log::critical($message);
Log::error($message);
Log::warning($message);
Log::notice($message);
Log::info($message);
Log::debug($message);

// チャンネルを指定する場合
Log::channel('slack')->info('INFOレベルです');

// 第2引数を使って文脈（追加情報）を追加する
Log::info('INFOレベルです', ['uid' => $id]);

// ヘルパー関数を使って
logs('daily')->info('INFOレベルですよ');
logs()->warning('WARNレベルです');
logger()->warning('WARNレベルです'); // 同上
info("INFOレベルです");
logger("DEBUGレベルです");
```

## Deprecation エラー対応
Laravel  Ver.8.65 以降では、PHP の Deprecation エラーが発生しても、何事も無かったかのように処理が続行されるようになりました。ただ、内部でこのエラーが発生している事をログとして残しておきたい事もあります。その時にこの設定を行います。

設定ファイルの該当箇所
```php
    'deprecations' => [
        'channel' => env('LOG_DEPRECATIONS_CHANNEL', 'null'), // ログを取るチャンネル
        'trace' => env('TRACE', false), // 一緒に stacktrace も取るか
    ],
```

例えば、`.env` で以下のように設定します。

```
LOG_DEPRECATIONS_CHANNEL=single
```

確認用コード
```php
// PHP 8.1 以降、パラメータを省略すると Deprecation エラー発生するので、ログられる
mb_check_encoding();
```

これで、将来廃止予定のものをいち早く気付くことができます。但し、本番サーバで稼働させるとログが大量になる恐れもありますので、開発サーバでのみ稼働させるという手も考えられます。