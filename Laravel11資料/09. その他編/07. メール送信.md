ドキュメント：[本家サイト](https://laravel.com/docs/11.x/mail) [日本語](https://readouble.com/laravel/11.x/ja/mail.html)

Laravel におけるメール送信の基本を見て行きます。なお、ここで扱う方式は、**Ver.9.35 からの新 Mailable を使った方式**になります。（ネット上では、旧式の情報も多いのでご注意下さい）

## メールの設定
.env ファイルにてメール送信方式の設定をします。

```php
MAIL_MAILER=log
MAIL_HOST=127.0.0.1
MAIL_PORT=2525
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null
MAIL_FROM_ADDRESS="hello@example.com"
MAIL_FROM_NAME="${APP_NAME}"
```

特に大事なのが、先頭の `MAIL_MAILER` で、`smtp`, `sendmail`, `log` などを指定できます。

- smtp … メール送信に SMTP サーバを指定します。MAIL_HOST など必要な情報をセットします。
- sendmail … 共有レンタルサーバなどでは、通常はこれで十分です。（時折一ひねり追加設定が必要なサーバもあります。Lolipop、heteml → `MAIL_SENDMAIL_PATH="/usr/sbin/sendmail -t"`）
- log … 実際のメール送信はしないで、ログにメールを記載するという方式です。Laravel 11 でデフォルトとなりました。

`MAIL_FROM_ADDRESS` は、デフォルトの差出人メールアドレス、`MAIL_FROM_NAME` は、デフォルトの差出人名として使われます。これに限りませんが、不要な項目は削除してOKです。

開発サーバ上でメール確認を便利にしてくれる Mailpit などの外部のツールもあります。（実際にメール送信をしない為、誤送信の心配がありません）

## Mailable を作成してみる
Laravel では、Mailable クラスを作成してメールを送信するのが一般的です。クラスを作成せずにメール送信することもできますが、自動テストとの兼ね合いを考えると、クラスを使う方が良いです。以下のコマンドを実行してクラスを作成します。

```bash
php artisan make:mail ContactMail
```

`ContactMail` の以下を変更してみましょう。

```php
use App\Models\User;

class ContactMail extends Mailable
{
    use Queueable, SerializesModels;

    public function __construct(public User $user)
    {
        //
    }

    public function envelope(): Envelope
    {
        return new Envelope(
            subject: 'メールの件名です',
            from: 'foo@example.net',
            to: 'foo@example.net',
        );
    }

    public function content(): Content
    {
        return new Content(
            text: 'emails.contact',
        );
    }
```

まず、コンストラクタで、public なプロパティ `$user` を定義しています。 public なプロパティを定義すると、それは view 側で自動で利用可能となります。$user 情報は、このクラスを利用する際（インスタンス化する際）に引き渡します。

`envelope` メソッド内で、件名、差出人、宛先等の情報を設定できます。下記のように書く事も出来ます。
```php
    public function envelope()
    {
        $envelope = new Envelope();

        return $envelope->subject('メールの件名です')
            ->from('foo@example.net', 'xxxx')
            ->to('foo@example.net');
    }
```

`content` メソッドでは、テンプレートファイルを指定します。デフォルトの `view` では、HTML メールとなります。`text` で、プレーンなメールとなります。2つ同時に指定する事も出来ます。（`view` の代わりに `html` と書いても同じです）

```php
return new Content(
    view: 'mail.contact.html',
    text: 'mail.contact.text'
);
```

以下のメールテンプレートを作成します。

views/emails/contact.blade.php
```php
こんにちは、{{ $user->name }}さん！

以上です。
```

メール処理を行う側は以下です。

web.php
```php
use App\Mail\ContactMail;
use App\Models\User;
use Illuminate\Support\Facades\Mail;

Route::get('mail', function () {
    $user = User::first();

    Mail::send(new ContactMail($user));

    return 'done';
});
```

以上でメールが送信されます。

なお今回のサンプルでは、Mailable 内でメールの宛先を指定しましたが、`Mail::send` する際に指定することもできます。
```php
Mail::to('hoge@example.net')->send(new ContactMail($user));
```
