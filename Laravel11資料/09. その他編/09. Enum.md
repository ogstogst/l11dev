ここでは、Enum をサポートする Laravel の機能を見て行きます。

Enum とは、列挙型を表す PHP 8.1 からの新しい機能です。ここでは Enum についてある程度の知識がある前提で進めさせていただきます。より詳しくは、PHP のドキュメントを参照して下さい。[列挙型 Enum](https://www.php.net/manual/ja/language.enumerations.php)

Enum は、PHP 言語の機能としては、PHP 8.1 からの登場ですが、それより前のバージョンにおいて、Enum 機能をエミュレートするような外部ライブラリが、多く使用されていました。ですので、「laravel enum」などで検索すると、それら外部ライブラリーの説明ブログなどが多くヒットしますが、それら外部ライブラリーは、もう役割は終えたと言えます。Google などで検索する場合はご注意下さい。

## マイグレーション
PHP とは別で、DB にも Enum 型という機能がありますが、もしそれを使う場合は、以下のようにします。

```php
$table->enum('rank', ['normal', 'special', 'premium']);
```

ですが、今回のサンプルでは、DB の Enum 型は使わずに、int 型を使用することにします。User 用マイグレーションファイルに以下を追加しましょう。

```php
Schema::create('users', function (Blueprint $table) {

	$table->unsignedTinyInteger('rank')->default(1);
});
```

そして UserFactory に、以下の1行を追加します。

database/factories/UserFactory.php
```php
    public function definition(): array
    {
        return [

            'rank' => fake()->numberBetween(1, 3),
        ];
    }
```

DB を再構築しましょう。

```bash
php artisan migrate:fresh --seed
```

## Enum ファイルの作成
Laravel 11 から、コマンドで Enum ファイルを作成する事ができます。
（VSCode を使っている場合 [PHP Create Class](https://marketplace.visualstudio.com/items?itemName=jaguadoromero.vscode-php-create-class) を使う方が早いかも知れません）

```bash
# int backed enum の作成
php artisan make:enum Enums/UserRank --int

# string backed enum の作成
php artisan make:enum Enums/UserRank --string
```

今回は、--int オプション付きで作成します。これで app/Enums/UserRank.php に Enum ファイルが作成されました。ファイルを編集して以下のようにしましょう。

app/Enums/UserRank.php
```php
<?php

namespace App\Enums;

enum UserRank: int
{
    case NORMAL = 1;
    case SPECIAL = 2;
    case PREMIUM = 3;

    public function label(): ?string
    {
        return match ($this) {
            self::NORMAL => '通常会員',
            self::SPECIAL => '特別会員',
            self::PREMIUM => 'プレミアム会員',
            default => null,
        };
    }
}
```

この Enum ファイルを活用する前の状態を確認しましょう。以下のように `web.php` に追記します。

web.php
```php
Route::get('enum', function () {
    $user = User::first();

    dd($user->rank);
});
```

/enum にアクセスすると、1～3の数字のいずれかが出力されます。rank の数字がそのまま取得されていますが、これでは応用が利きません。そこで、作成した Enum ファイルを活用しましょう。Laravel が提供する casts の設定をします。

## Enum キャスト
User モデルに以下を追記します。

Modesl/User.php
```php
use App\Enums\UserRank;

class User extends Authenticatable
{

    protected function casts(): array
    {
        return [

            'rank' => UserRank::class,
        ];
    }
```

この設定により、DB から取得した 1 などのデータは、Enum として取得されるようになります。先程の出力結果は以下のように変更になりました。

表示結果
```php
App\Enums\UserRank {#1195 ▼ // routes/web.php:18
  +name: "NORMAL"
  +value: 1
}
```

これで応用が利くようになりました。`web.php` を以下のように変更してみましょう。

web.php
```php
Route::get('enum', function () {
    $user = User::first();

    dump($user->rank->label());
    dump($user->rank->name);
    dump($user->rank->value);
});
```

これで、必要な情報が得られるようになりました。

表示結果
```php
"通常会員" // routes/web.php:18
"NORMAL" // routes/web.php:19
1 // routes/web.php:20
```

## Enum バリデーション
上記では、rank の値は、1~3 の数値と定義しました。例えば管理者がユーザーを登録する際、`rank` 項目がこの数字のいずれかに該当するかをバリデーションしたい事は多いと思います。その場合、以下のように書けます。

web.php
```php
use App\Enums\UserRank;
use Illuminate\Validation\Rules\Enum;

Route::get('enum_vali', function (Request $request) {
    $in = [
        'rank' => 4,
    ];

    $validator = validator($in, [
        'rank' => ['required', 'integer', new Enum(UserRank::class)],
    ]);

    return $validator->fails() ? 'failed' : 'ok.';
});
```

ポイント部分は、`new Enum(UserRank::class)` の箇所です。これで、ユーザーからの入力値が、Enum に定義した 1～3 の数値かをチェックできます。

ドキュメント：[本家サイト](https://laravel.com/docs/11.x/validation#rule-enum) [日本語](https://readouble.com/laravel/11.x/ja/validation.html#rule-enum)

## Enum 結合
ルートモデル結合と似た機能ですが、モデルではなく、Enum に対して行う事ができます。この機能は、string backed enum に対してのみ機能します。
以下は、ドキュメントより。

app/Enums/Category.php
```php
namespace App\Enums;
 
enum Category: string
{
    case Fruits = 'fruits';
    case People = 'people';
}
```

web.php
```php
use App\Enums\Category;
use Illuminate\Support\Facades\Route;
 
Route::get('/categories/{category}', function (Category $category) {
    return $category->value;
});
```

int backed enum に対しては動作しません。Laravel 11.4 で一瞬搭載されましたが、既存アプリに影響があった為、また元に戻されました。Laravel 12 では搭載される可能性は、大です。