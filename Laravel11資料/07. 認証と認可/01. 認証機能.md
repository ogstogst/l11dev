ドキュメント：[本家サイト](https://laravel.com/docs/11.x/authentication) [日本語](https://readouble.com/laravel/11.x/ja/authentication.html)

認証とは、正規ユーザーであるのを確認する事を言います。本人確認と言った方が分かり易いでしょうか。
Laravel では、Laravel Breeze という認証スタータキットが用意されていて、それを導入するとログイン画面も含めて認証に必要なセット一式が、パッと用意できるものがありますが、ここではそのベースとなる認証機能そのものを見ていきます。

まず、認証機能を実現するメソッドを確認し、実際にログイン処理機能を作成して行きましょう。

### 認証周りのメソッド
認証関係のメソッドは、`Auth` ファサード経由又は `auth` ヘルパー経由で使う事ができます。
以下、主なメソッドです。

```php
use Illuminate\Support\Facades\Auth;

// ログイン済みユーザーのモデルを得る
$user = $request->user();
$user = Auth::user();
$user = auth()->user();

$id = Auth::id(); // ログイン済みユーザーの連番IDを取得

$user = User::find(1);
Auth::login($user);      // 指定のユーザーでログインさせた事にする
Auth::loginUsingId(5);   // 連番のユーザーでログインさせた事にする
Auth::check();           // 現在ログイン済みかチェックする（true / false）
Auth::logout();          // 認証済みユーザーをログアウトさせる

Auth::attempt($data); // 配列 $data の条件で、ログイン認証を試みる。（成功時…true、失敗時…false）
//例）$data = ['email' => 'aaa@example.net', 'password' => 'abcd1234'];

// 第2引数に true を渡す事により、持続的ログイン（「次回から自動でログインする」機能）を行える
Auth::attempt($data, true);
```

デフォルトでは、`web` というガード名が使用されます。もしマルチ認証などで異なるガード名を指定する場合は、以下のようにします。（`admin` ガード名を想定）

```php
Auth::guard('admin')->attempt($data);
auth('admin')->attempt($data);
```

## 認証の実装
以降では、認証機能を実装して行きます。まずは会員専用ページを作成しましょう。
web.php に以下を追加して下さい。

```php
Route::get('member', function () {
    $user = Auth::user();

    return view('member', compact('user'));
})->middleware('auth')->name('member');
```

ポイントは、`auth` ミドルウェアです。このミドルウェアを仕掛けたルートは、認証が必要な URL となります。

この状態で、`/member` にアクセスすると、`Route [login] not defined.` というようなエラーが出ます。認証済みでない時に認証ページを開こうとすると、Laravel では、デフォルトで `login` というルート名を持つルート（ログイン画面）に転送しようとするからです。という事で、`login` というルート名でログイン画面のルートを作成しましょう。その前に、LoginController を作成します。

```bash
php artisan make:controller LoginController
```

LoginController
```php
class LoginController extends Controller
{
    public function showLoginForm()
    {
        return view('login');
    }
}
```

web.php
```php
Route::get('login', [LoginController::class, 'showLoginForm'])->name('login');
```

（補足）
もしこの場合において、認証済みの人は、ログイン画面を開けないようにするには、`guest` ミドルウェアを追加します。`->middleware('guest')` ここでは追加しない事とします。

ログイン画面は以下です。

views/login.blade.php
```html
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ログイン画面</title>
</head>
<body>

  <h1>ログイン画面</h1>

  <form method="post">
    @csrf

    {{-- エラーメッセージ --}}
    @if($errors->any())
        <ul style="color: red">
        @foreach($errors->all() as $error)
            <li>{{ $error }}</li>
        @endforeach
        </ul>
    @endif

    {{-- 普通のメッセージ --}}
    @session('status')
      <p style="color: green">
        {{ $value }}
      </p>
    @endsession

    <p>
        <label>メールアドレス</label>
        <input type="text" name="email" value="{{ old('email') }}">
    </p>
    <p>
        <label>パスワード</label>
        <input type="password" name="password">
    </p>

    <input type="submit" value="　送信する　">

  </form>

</body>
</html>
```

これで、`/member` にアクセスすると、ログイン画面が表示されるようになります。続けて、ログイン処理を追加しましょう。

web.php
```php
Route::post('login', [LoginController::class, 'login']);
```

LoginController
```php
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

    public function login(Request $request)
    {
        $data = $request->validate([
            'email' => ['required', 'string', 'email:filter'],
            'password' => ['required', 'string'],
        ]);

        if (Auth::attempt($data)) {
            $request->session()->regenerate();

            return to_route('member');
        }

        return back()->withErrors([
            'email' => 'メールアドレスかパスワードが間違っています。',
        ])->onlyInput('email');
    }
```

`Auth::attempt()` で、ログイン処理を試みて、認証を通れば、これでログイン状態となります。

参考：ドキュメント（ユーザーを手作業で認証する） https://readouble.com/laravel/11.x/ja/authentication.html#authenticating-users

会員画面の view も作成しましょう。

views/member.blade.php
```html
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>会員画面</title>
</head>
<body>

ようこそ、{{ $user->name }}さん

</body>
</html>
```

続けて、ログアウト処理も作成しましょう。上記、member.blade.php にログアウトボタンを追加します。

```html
<form method="post" action="{{ route('logout') }}">
  @csrf
  <input type="submit" value="ログアウト">
</form>
```

web.php
```php
Route::post('logout', [LoginController::class, 'logout'])->name('logout');
```

LoginController
```php
    public function logout(Request $request)
    {
        Auth::logout();

        $request->session()->invalidate();

        $request->session()->regenerateToken();

        return to_route('login')->with('status', 'ログアウトしました');
    }
```
