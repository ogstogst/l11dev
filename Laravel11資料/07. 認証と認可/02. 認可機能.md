ドキュメント：[本家サイト](https://laravel.com/docs/11.x/authorization) [日本語](https://readouble.com/laravel/11.x/ja/authorization.html)

認可とは、必要な権限を有しているかのチェック機能になります。例えば、「一般ユーザーは、管理者ページを開けない」とか「ブログ投稿を削除できるのは、書いた本人に限る」などです。Laravel ではこれら認可機能を Gate 又は Policy という定義方法を使って構築する事ができます。

## Gate と Policy の使い分け
どちらも認可を実現するという点においては同じですが、認可ロジックの定義方法により Gate と Policy の2つがあります。特徴と使い分けは以下の通りです。

### Gate
- サクッと作成したい時
- 特定のモデルに関係ない（依存しない）ものに対して認可をする時
- （特定のモデルに関係する時に使用する事も可能）

### Policy
- クラスベースでしっかり記述する時
- 特定のモデルに関係する時

上記で言う「特定のモデルに関係する時」とは、「ブログ投稿を削除できるのは、書いた本人に限る」と言った場合のブログモデルです。逆に関係しない時とは、「一般ユーザーは、管理者ページを開けない」などより汎用的な使い方の事です。

## Gate 機能を使ってみる
では、認証機能の続きで、ここでは、Gate を使って認可を実装してみます。
書く場所に決まりはありませんが、Laravel 11 以降では、AppServiceProvider が宜しいでしょう。

ここでは、ユーザーのメールアドレスが、`shiro@foo.bar` （任意で変更して下さい）の時のみ、会員ページを開ける事とします。

```php
use App\Models\User;
use Illuminate\Support\Facades\Gate;

class AppServiceProvider extends ServiceProvider
{
    public function boot(): void
    {
        Gate::define('only-admin', function (User $user) {
            return $user->email === 'shiro@foo.bar';
        });
    }
```

`Gate::define` の第1引数の `only-admin` は、この認可に付ける名前です。第2引数の無名関数で、認可するロジックを定義します。`$user` で、ログインしているユーザーモデルを取得できます。
この認可を適用する必要がありますので、web.php を以下のように追記します。

```php
use Illuminate\Support\Facades\Gate;

Route::get('member', function () {
    if (! Gate::allows('only-admin')) {    // ← この箇所です
        abort(403);
    }

    $user = Auth::user();

    return view('member', compact('user'));
})->middleware('auth')->name('member');
```

これで、`shiro@foo.bar` 以外のメールアドレスの人がログインしても、会員ページを開けなくなり、`403 Forbidden` と表示されます。

この認可を適用する方法は、下記の通り幾つかあります。（これら以外にも方法はありますが、Laravel 11 時代にはお勧めでは無いため、省略します）

```php
// 先の3行を1行のみで
Gate::authorize('only-admin');

// 下記のような形でも
if ($request->user()->cannot('only-admin')) {
	abort(403);
}

// view 内で
@can('only-admin')    // 反対の @cannot() もあり
  権限ある場合
@else
  権限ない場合
@endcan
    
// ミドルウェアを使って
})->middleware(['auth', 'can:only-admin'])
```

