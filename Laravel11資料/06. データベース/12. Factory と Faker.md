ドキュメント：[本家サイト](https://laravel.com/docs/11.x/eloquent-factories) [日本語](https://readouble.com/laravel/11.x/ja/eloquent-factories.html)

開発中、特にブラウザを使って動作を確認する際は、DB 上にダミーのデータが必要になります。ダミーデータは、何度でも登録出来るようにプログラム的に記述する必要があります。Laravel では、DatabaseSeeder.php に登録用の記述を書き、コマンドを実行する事で、ダミーデータの登録ができます。ダミーデータの作成には、Factory と Faker 機能を利用します。Factory は、ダミーデータを作成する際に便利な機能を提供してくれます。また、Factory の中で、Faker が利用されます。Faker は、ランダムなデータを生成する機能です。

## Factory
Factory 機能は、特に PHPUnit を使った自動テストの際にはフル活用しますが、ブラウザを使ったテストをする際にもダミーデータを入れるのに重宝します。ここでは簡単に一例を見て行きます。

ユーザーは多数のブログ投稿を持っている（User has many posts）というテーブル関係を想定しています。
ユーザーを10件作成し、その各ユーザーが、2～5件のブログ投稿を所有している場合のダミーデータを作成します。

### Factory ファイルの生成
以下のコマンドで生成できます。

```bash
php artisan make:factory PostFactory

# モデルファイル生成と同時に migration と factory も一緒に
php artisan make:model Post -mf
```

マイグレーションファイルの内容は、「DB の設定」で見た内容を記述する事とします。

また、 `database/factories/PostFactory.php` ファイルが生成されますので、definition 内に以下のように記述します。

```php
use App\Models\User;

class PostFactory extends Factory
{
    public function definition(): array
    {
        return [
            'user_id' => User::factory(),
            'title' => fake()->realText(20),
            'body' => fake()->realText(50),
        ];
    }
}
```

ここで定義した各項目の値は、Factory の `create()` メソッドに配列を渡す事で、上書きすることができます。
上記の `User::factory()` の記述は、そのように書く事で、Post のダミーデータを1件生成すると、それと同時に User モデルが登録され、その User モデルの ID が、`user_id` にセットされる事を意味します。
以下のコードで挙動を確認してみます。

database/seeders/DatabaseSeeder.php
```php
use App\Models\Post;

    public function run(): void
    {
        Post::factory()->create([
            'title' => 'ブログのタイトル',
        ]);
    }
```

以下のコマンドを使って確認してみましょう。

```bash
# DB 再生成と同時にシーディング
php artisan migrate:fresh --seed

# シーディングのみ
php artisan db:seed
```

### DatabaseSeeder
より現実的な記述を見てみましょう。
下記で、ユーザーを10件作成し、各ユーザーに対して、2～5件のブログ投稿を所有させています。

DatabaseSeeder.php
```php
use App\Models\Post;
use App\Models\User;

class DatabaseSeeder extends Seeder
{
    public function run(): void
    {
        $users = User::factory(10)->create();

        foreach ($users as $user) {
            Post::factory(random_int(2, 5))->create(['user_id' => $user]);
        }
    }
}
```

#### 進化版
上記を更に進化させました。テストする際には、自分の知っているアカウントが必要になりますので、例えば以下のようにして、それ専用のアカウントにセットします。

```php
    public function run(): void
    {
        [$me] = User::factory(10)->create()->each(function ($user) {
            Post::factory(random_int(2, 5))->create(['user_id' => $user]);
        });

        $me->update([
            'name' => '小太郎',
            'email' => 'shiro@foo.bar',
            'password' => \Hash::make('hogehoge'),
        ]);
    }
```

## Faker
ランダムなデータの生成に利用されます。数多くのメソッドがある為1つ1つは紹介しきれませんので、下記筆者のページにてご確認下さい。
https://github.com/nshiro/faker-summary/blob/master/README.md

faker の書き方ですが、バージョンによって少し変化しています。
```php
// 昔
$faker->name
$this->faker->name

// 少し昔
$this->faker->name()

// 今
fake()->name()
```

「少し昔」か「今」の書き方で書くようにして下さい。注意点としては、

1. 「昔」は、プロパティ形式で書いていましたが、今はメソッドで書きます。プロパティ形式は、いずれ使えなくなります。
1. 「今」の書き方は、`faker()` ではなく、`fake()` です。

### Faker の日本語対応
以下のように記述することで、日本語対応できます。
但し、全てのメソッドが日本語化対応している訳ではありません。

.env
```php
APP_FAKER_LOCALE=ja_JP
```

Laravel 10 以前の場合は、config/app.php にて
```php
'faker_locale' => 'ja_JP',
```

