ドキュメント：[本家サイト1](https://laravel.com/docs/11.x/database#running-queries) [本家サイト2](https://readouble.com/laravel/11.x/ja/database.html#running-queries)  [日本語1](https://laravel.com/docs/11.x/queries)  [日本語1](https://readouble.com/laravel/11.x/ja/queries.html)

データベースからデータを取得する方法について見て行きます。データの取得以外にもデータの登録、更新、削除などもある訳ですが、ここでは、取得のみについて見て行きます。

以下のようなやり方があります。
1. SQL 文を直接書く方法（通常は使わない）
2. Query Builder を使う方法（たまに使う）
3. Eloquent Builder を使う方法（本命）

## SQL 文を直接書く方法
SQL文を直接書くタイプ。取得したデータは、[PHP 標準オブジェクト（stdClass）](https://www.php.net/manual/ja/class.stdclass.php)の配列で返る。

```php
use Illuminate\Support\Facades\DB;

$users = DB::select('select * from users');

// プレイスホルダーを使うことで、適切に文字列がエスケープされてから SQL が実行される
$users = DB::select('select * from users where name = ?', ['taro']);
$users = DB::select('select * from users where name = :name', ['name' => 'taro']);

dd($users);
```

## Query Builder を使う方法
ダミーデータの登録などで使ったりもします。（大量のデータを登録する時など）
書き始め以外は、次に見る Eloquent と基本的に共通の書き方になります。

複数のデータを取得するメソッド（`get` 等）で取得したデータは、PHP 標準オブジェクト（stdClass）のコレクション型（`Illuminate\Support\Collection`）で返されます。
1つのデータを取得するメソッド（`find` 等）の場合は、PHP 標準オブジェクト（stdClass）で返されます（該当データが無い場合は、null）。

```php
use Illuminate\Support\Facades\DB;

// get() で該当するデータを全て取得
$users = DB::table('users')->get();

// 条件を絞って検索
$users = DB::table('users')->where('id', '>', 5)->get();  // '=' の時は、省略可能

// 部分一致検索
$users = DB::table('users')->where('email', 'LIKE', '%example%')->get();

// 該当する最初の1件のみ取得
// 結果は、PHP標準オブジェクト。該当データが無ければ、null
$user = DB::table('users')->where('id', '>', 5)->first();

// 主キーで取得する
// 結果は、PHP標準オブジェクト。該当データが無ければ、null
$user = DB::table('users')->find(3);

->whereIn('id', [1, 2, 3]);
->whereBetween('id', [1, 5]);
->whereNull('email');
->whereNotNull('email');
->whereDate('created_at', '2016-12-31')  // whereMonth / whereDay / whereYear / whereTime
```

### and 検索
->where() を繋げて書けば、AND 検索になる。

```php
$users = DB::table('users')
    ->where('name', 'taro')
    ->where('email', 'taro@example.net')
    ->get();

// 上記は、配列を使って1つでも書けます
$users = DB::table('users')
    ->where([['name', 'taro'], ['email', 'taro@example.net']])
    ->get();
```

### or 検索
->orWhere() で、OR 検索も書けるが、通常は注意が必要。

```php
// 「name が 'taro' 又は email が 'taro@example.net'」 且つ 「id が 6 以上」を検索する場合

// NG
$users = DB::table('users')
    ->where('name', 'taro')
    ->orWhere('email', 'taro@example.net')
    ->where('id', '>', 5)
    ->get();

// 上記だと「name が 'taro'」又は「email が 'taro@example.net' 且つ id が 6 以上」で検索されてしまう。
// AND 演算子が OR 演算子よりも優先される為

// OK
$users = DB::table('users')
    ->where(function ($query) {
        $query->where('name', 'taro')
            ->orWhere('email', 'taro@example.net');
    })
    ->where('id', '>', 5)
    ->get();
```

### orderBy
並び替えは、->orderBy() を使います。
where 同様、複数繋げて書く事も可能。

```php
$users = DB::table('users')
    ->where('id', '>', '3')
    ->orderBy('id', 'DESC') // 'ASC', 'DESC' を省略した場合は、'ASC'となる ->orderByDesc('id') もあり。
    ->get();
```

latest(), oldest() を使い最新順（降順）、古い順（昇順）の指定ができる。デフォルトは、created_at が使われる。

```php
$users = DB::table('users')
    ->latest() // ->orderBy('created_at', 'DESC') と等価
    ->get();

$users = DB::table('users')
    ->oldest('id') // ->orderBy('id', 'ASC') と等価
    ->get();
```

->inRandomOrder() ランダム順

```php
$users = DB::table('users')
    ->inRandomOrder()
    ->get();
```

#### Limit & Offset
skip / take 又は、offset / limit を使います。

```php
$users = DB::table('users')->skip(10)->take(5)->get(); // 最初の10件を飛ばして、5件限定で取得。
$users = DB::table('users')->offset(10)->limit(5)->get(); // 同上
```

#### join(), leftJoin(), rightJoin()

```php
$users = DB::table('users')
    ->join('posts', 'users.id', '=', 'posts.user_id')
    ->select('users.*', 'posts.*')
    ->get();

foreach ($users as $user) {
	dd($user->title); // $user->title という割には、ブログ投稿の title だったり。
}
```

Eloquent の機能を使いこなしていれば、join 系はさほど使わないかも知れません。
また、一見分かりにくい事にもなる為、使用には注意が必要です。

## Eloquent Builder
次ページに続く。