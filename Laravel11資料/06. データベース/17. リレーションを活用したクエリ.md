ドキュメント：[本家サイト](https://laravel.com/docs/11.x/eloquent-relationships#aggregating-related-models) [日本語](https://readouble.com/laravel/11.x/ja/eloquent-relationships.html#aggregating-related-models)

Laravel のリレーション機能を活用すると、一見複雑になりそうな SQL クエリでも 簡単に実現できるようになります。幾つか実例で見てみましょう。

### ブログ投稿を1つ以上書いたユーザーを検索する
以下のように `has` メソッドを利用すると簡単に実現できます。

```php
$users = User::has('posts')->get();

// 2ブログ以上とする場合
$users = User::has('posts', '>=', 2)->get();
```

### タイトルに hoge を含むブログを書いたユーザーを検索する
上記と異なり細かい条件設定が必要な場合は、`whereHas` メソッドを使い、コールバック関数を指定してやります。

```php
$users = User::whereHas('posts', function ($query) {
	$query->where('title', 'LIKE', '%hoge%');
})->get();
```

上記で、`has` と `whereHas` を見ましたが、これと逆の働きをする `doesntHave`, `whereDoesntHave` のメソッドもあります。

### ユーザー一覧表示と同時にそのユーザーが書いたブログ投稿数も表示したい
`withCount` メソッドを使うと簡単にできます。ブログ投稿数は、`リレーション名_count` の形、つまりここでは  `posts_count` プロパティとして値を取得出来ます。

```php
$users = User::withCount('posts')->get();

return view('welcome', compact('users'));
```

welcome.blade.php
```php
<ul>
  @foreach($users as $user)
    <li>{{ $user->name }} / {{ $user->posts_count }}</li>
  @endforeach
</ul>
```

#### 上記において、ブログ投稿数の多い順にユーザーを並べたい場合
`posts_count` を使ってソートしてやります。

```php
$users = User::withCount('posts')->orderByDesc('posts_count')->get();
```

### ユーザー一覧表示と同時にそのユーザーが最後に（最新の）ブログを書いた日時を表示する
`withCount` と似たパターンですが、こちらは、`withMax` メソッドで実現できます。

```php
$users = User::withMax('posts', 'created_at')->get();

return view('welcome', compact('users'));
```

welcome.blade.php
```php
<ul>
  @foreach($users as $user)
    <li>{{ $user->name }} / {{ $user->posts_max_created_at }}</li>
  @endforeach
</ul>
```

`リレーション名_max_項目名` の形で対応する値を取得出来ます。

このような集約系は他にも `withMin`, `withMax`, `withAvg`, `withSum`, `withExists` などがあります。

### 名前に taro を含むユーザーが書いたブログ一覧を表示する
今度は今までとは異なり、ユーザーではなく、ブログが主体です。関係は入れ替わりますが、ここでも `whereHas` が利用できます。

```php
$posts = Post::with('user')->whereHas('user', function ($query) {
    $query->where('name', 'LIKE', '%taro%');
})->get();

return view('welcome', compact('posts'));
```

welcome.blade.php
```php
<ul>
  @foreach($posts as $post)
    <li>{{ $post->title }} / {{ $post->user->name }}</li>
  @endforeach
</ul>
```

#### 補足情報
上記で書いた `with('user')` は、N+1 問題対策用です。ユーザーの名前を表示しないのであれば、不要な所でした。
この `with` と `whereHas` は、ある意味セットな為、下記のように書く事もできます。

```php
$posts = Post::withWhereHas('user', function ($query) {
    $query->where('name', 'LIKE', '%taro%');
})->get();
```
