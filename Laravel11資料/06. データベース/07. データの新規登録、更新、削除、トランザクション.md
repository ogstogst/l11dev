ドキュメント：[本家サイト](https://laravel.com/docs/11.x/eloquent#inserting-and-updating-models) [日本語](https://readouble.com/laravel/11.x/ja/eloquent.html#inserting-and-updating-models)

Eloquent を使ったデータの新規登録、更新、削除方法を見て行きます。

## データの新規登録
新規でデータベースにモデルデータを登録する方法は、1つではありません。幾つかのパターンを見てみます。

（注）下記サンプルを複数回試す時は、メールアドレスを都度変更して下さい。（重複エラーを避ける為）

```php
use App\Models\User;
use Illuminate\Support\Facades\Hash;

// (1) 個別に設定してから、save() メソッドを呼び出す
$user = new User();
$user->name = '山田太郎';
$user->email = 'aaa@example.net';
$user->password = Hash::make('password'),
$user->save();

// ～～～ 以下は、事前の設定（Mass Assignment（fillable or guarded））が必要 ～～～

// (2) インスタンス化する際に引数でデータを引き渡す
$user = new User([
    'name' => '山田太郎',
    'email' => 'aaa@example.net',
    'password' => Hash::make('password'),
]);
$user->save();

// (3) save() ではなく、直接 create() を呼び出す
$user = User::create([
    'name' => '山田太郎',
    'email' => 'aaa@example.net',
    'password' => Hash::make('password'),
]);

// (3') バリデーションを通ったデータのみ引き渡す
$data = $request->validate([
    'name' => ['required', '...'],
    'email' => ['required', '...'],
    'password' => ['required', '...'],
]);
User::create($data);

// (4) fill() を使う方法も
$user = new User();
$user->fill($data);
$user->save();
```

## データの更新
`save()` 又は `update()` メソッドを使います。

```php
// (1) save() メソッド利用
$user = User::findOrFail(1);
$user->name = '山田太郎';
$user->email = 'aaa@example.net';
$user->save();

// (2) update() メソッド利用
$user = User::findOrFail(1);
$user->update([
    'name' => '山田太郎',
    'email' => 'aaa@example.net',
]);
```

## データの削除
`delete()`  又は `destroy()` メソッドを使います。

```php
$user = User::findOrFail(1);
$user->delete();

User::destroy(1); // 連番を指定
User::destroy([1, 2, 3]); // 配列で複数指定可

User::where('id', 1)->delete(); // SQL で直接削除するやり方（イベントは発生しない）
```

## トランザクション
データベースにおけるトランザクションとは、一連の複数の SQL のいずれかが失敗した場合は、それら全てを取り消し、逆に全てが成功すれば、全てが反映される仕組みを言います。
Laravel では、簡単にこれを実現する事が出来ます。

```php
use Illuminate\Support\Facades\DB;
 
DB::transaction(function () {
    DB::update('update users set votes = 1');
    
    DB::delete('delete from posts');
});
```
