ドキュメント：[本家サイト](https://laravel.com/docs/11.x/eloquent-relationships#eager-loading) [日本語](https://readouble.com/laravel/11.x/ja/eloquent-relationships.html#eager-loading)

N + 1 問題とは、例えば、10件分のブログを取得し、更にその10件分のブログの所有者（名前）を表示する際に、1回（ブログ取得分）＋10回（所有者取得分）の SQL クエリが走ってしまい、データの数が増えるだけ、SQL の数も増えてしまう問題を言います。

N + 1 問題を確認する為のコード
```php
$posts = Post::get();

foreach ($posts as $post) {
    $post->user->name; // ここで、都度都度、SQL が走る
}
```

以下のように SQL が沢山発行されてしまいます。（イメージ）
```sql
select * from `posts`
select * from `users` where `users`.`id` = '1' limit 1
select * from `users` where `users`.`id` = '1' limit 1
select * from `users` where `users`.`id` = '1' limit 1
select * from `users` where `users`.`id` = '2' limit 1
select * from `users` where `users`.`id` = '2' limit 1
select * from `users` where `users`.`id` = '2' limit 1
select * from `users` where `users`.`id` = '3' limit 1
select * from `users` where `users`.`id` = '3' limit 1
select * from `users` where `users`.`id` = '3' limit 1
（～ 続く ～）
```

## Lazy ロード と Eager ロード
**Lazy ロード**は、上記のような今までのやり方で、リレーション先のデータが必要になった際に、SQL が走ってデータを取ってきます。

Laravel では、N + 1 問題を解決する仕組みが用意されています。データが必要になる度に SQL を発行してデータを取ってくるのでは無く、予め必要となるデータをガッと先に一括で取得しておき、実際にデータが必要となった際にその取得済みデータを利用する（キャッシュを利用）する事で、N + 1 問題を解決します。

具体的には、`with()` メソッドでリレーション先を指定する事で、予めリレーション先のデータが一括で取得され（**Eager ロード**）、それを一時的にキャッシュしておき、各リレーション先データを使用する際は、**動的プロパティ**を使ってキャッシュが利用されるようにします。すると、都度都度 SQL は発生せず、N + 1 問題が解消されます。

以下で、N + 1 問題が解決できます。
```php
$posts = Post::with('user')->get();

foreach ($posts as $post) {
    $post->user->name;
}
```

以下は、イメージです。
```php
$posts = Post::with('user')->get();

// 上記を実行すると、以下の SQL が実行される。（例）
select * from `posts`;
select * from `users` where `users`.`id` in (1, 2, 3, 4, 5, 6, 7, 8, 9, 10);

// そして Laravel は、各 post データに該当する user 情報をキャッシュで仕込みます。
// ↓イメージ
foreach ($posts as $post) {
    $post[キャッシュ]['user'] = 該当user情報;
}

// その後は、動的プロパティを使っている限り、上記でキャッシュした内容が使われる。
```

### with() のネスト
`with()` は、更にネスト化されたリレーションも指定する事が出来ます。

user belongsTo company という状況の時
```php
$posts = Post::with('user.company')->get();

foreach ($posts as $post) {
    $post->user->company->name;
}
```

### N + 1 問題の検知
既に他のページで見ましたが、`AppServiceProvider` に以下の記述をすることで、N + 1 の発生を検知することが出来ます。

```php
use Illuminate\Database\Eloquent\Model;

class AppServiceProvider extends ServiceProvider

    public function boot()
    {
        // 一括で設定する
        // 本番環境以外で有効にする
        Model::shouldBeStrict(! $this->app->isProduction());
    }
```

なお、この機能は、動的プロパティを使っている場合に限り検知できます。リレーションメソッドを直接呼び出す事による N + 1 問題は検知できません。