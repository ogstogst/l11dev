ドキュメント：[本家サイト](https://laravel.com/docs/11.x/validation#form-request-validation) [日本語](https://readouble.com/laravel/11.x/ja/validation.html#form-request-validation)

今までコントローラでバリデーションをやっていましたが、複雑なバリデーションになってくると、コントローラが太っちょになってきてしまいます。そこで、Laravel では、フォームリクエストという仕組みを使って解決できます。

コマンドでフォームリクエストを作成
```bash
php artisan make:request UserSaveRequest
```

すると以下のようなファイルが生成されます。
```php
<?php

namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class UserSaveRequest extends FormRequest
{
    public function authorize(): bool
    {
        return false;
    }

    public function rules(): array
    {
        return [
            //
        ];
    }
}

```

`authorize` は、認可処理を書く前提になっておりますが、通常はあまりここで認可処理を書きません。これが `false` を返していると認可処理で弾かれますので、`true` を返すようにします。又は、このメソッドごと削除すれば、`true` を返した事になります。

`rules()` 内にルールを記述します。以下のように変更しましょう。
```php
use App\Rules\RequiredIfNanashi;

    public function rules(): array
    {
        return [
            'name' => ['required', 'string'],
            'email' => ['required', 'string', 'lowercase', 'email:filter', 'max:255'],
            'nickname' => ['nullable', 'string', 'max:255', new RequiredIfNanashi($this->input('name'))],
        ];
    }
```

コントローラに書いた際は、`$request->input('name')` としていましたが、フォームリクエスト内では、`$this->input('name')` と書けば OK です。

また、`attributes` メソッドを利用して項目名に日本語を指定したり、`messages` メソッドを利用してオリジナルのエラーメッセージを指定する事ができます。

```php
    public function attributes(): array
    {
        return [
            'name' => 'お名前',
            'nickname' => 'ニックネーム',
            'email' => 'メールアドレス',
        ];
    }

    public function messages(): array
    {
        return [
            'name.required' => ':attributeは、必ず入力して下さい！！！',
        ];
    }
```

最後にコントローラを以下のように変更します。

```php
use App\Http\Requests\UserSaveRequest;

    public function indexPost(UserSaveRequest $request)
    {
        $validated = $request->validated();

        dd($validated);
    }
```

これで、`indexPost` メソッドが呼ばれる前に、フォームリクエストのバリデーションが走ります。バリデーションに成功すれば続けて処理が実行されます。バリデーションに失敗すれば、1つ前の画面にリダイレクトされます。

 `validated` メソッドを使い、バリデーションを通ったデータを取得することができます。これは、最大でもバリデーションを行った項目のみに限定されます。（一部、配列の例外を除く）

### データの加工等
フォームリクエストには意外と多くのメソッドがありますが、データの加工等には、`prepareForValidation` などが利用できます。ここでは、メールアドレスの大文字を小文字に変換してみましょう。フォームリクエストに以下を追加します。

```php
    protected function prepareForValidation()
    {
        $email = $this->input('email');

        if (! is_null($email)) {
            // 検証用のデータに対しては、こちらが効きます
            $this->merge(['email' => strtolower($email)]);
        }

        // 入力エラー時の画面にも反映させたい場合
        request()->merge(['email' => strtolower($email)]);
    }
```