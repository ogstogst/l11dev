ドキュメント：[本家サイト](https://laravel.com/docs/11.x/validation#custom-validation-rules) [日本語](https://readouble.com/laravel/11.x/ja/validation.html#custom-validation-rules)

Laravel ではカスタムルール（独自のバリデーション）を作成することができます。ただ、カスタムルールを作成する前に、Laravel 標準のルールで既に同じ機能が提供されていないか確認してみましょう。カスタムルールに限らずですが、Laravel では多くの人が必要とする機能は、既に標準で提供されていたりもします。

以下の2通りの方法で作成できます。
- クロージャー（無名関数）
- ルールオブジェクト（クラスベース）

## クロージャー
その場限りのルールや簡単なコードで済むルール向けです。

サンプルコード
```php
$request->validate([
    'name' => ['required', 'string', function ($attribute, $value, $fail) {
        if ($value === '名無し') {
            $fail("名前は、「名無し」以外でお願いします。");
        }
    }],
]);
```

## ルールオブジェクト
使い回せるルールや少し複雑なルール、又はクロージャーでは実現が難しい時にルールオブジェクトを使用します。
ここでは、名前が「名無し」の時は、ニックネーム欄は、必須になるというカスタムルールを作ってみます。もっとも  Laravel 標準の  `required_if` を使えば自作する必要は無いのですが、学習の為に見て行きたいと思います。

下記コマンドでファイルを生成します。
```bash
php artisan make:rule RequiredIfNanashi
```

以下のようにファイルを編集します。使い回しが効くように作成します。

app/Rules/RequiredIfNanashi.php **（まだ問題のあるコードです）**
```php
<?php

namespace App\Rules;

use Closure;
use Illuminate\Contracts\Validation\ValidationRule;

class RequiredIfNanashi implements ValidationRule
{
    public function __construct(private mixed $name)
    {
        //
    }

    public function validate(string $attribute, mixed $value, Closure $fail): void
    {
        if (is_string($this->name) && $this->name === '名無し' && blank($value)) {
            $fail("名前が名無しの時は、:attributeを入力して下さい。")->translate();
        }
    }
}
```

入力欄に nickname 欄を追加します。

```html
ニックネーム：<input type="text" name="nickname" value="{{ old('nickname') }}">
```

`validate()` メソッドを以下のように変更します。

ValidateController.php
```php
use App\Rules\RequiredIfNanashi;

$request->validate([
    'name' => ['required', 'string'],
    'nickname' => ['nullable', 'string', 'max:255', new RequiredIfNanashi($request->input('name'))],
], [], ['nickname' => 'ニックネーム']);
```

これで、名前が「名無し」の時は、ニックネームが必須になったかと思いきや、そうでもありません。何か違っているようです。実は、この自作ルールは、`email` などと同じように「一般系」のメソッドに属しています。`nullable` の指定もありますので、何も入力しない時は、普通に通ってしまいます。この問題を修正する為に、以下のように変更します。

app/Rules/RequiredIfNanashi.php
```php
class RequiredIfNanashi implements ValidationRule
{
    public $implicit = true;

```

`implicit` プロパティを `true` に設定する事で、「一般系」のルールが「必須系」と変わります。これで先程の問題は解消します。この `implicit` プロパティを `true` にする時は、コマンドでファイルを生成する際に、`--implict` オプションを付けると最初から付いてきます。

```bash
php artisan make:rule RequiredIfNanashi --implict
```

クロージャーの場合は、このような機能は無いため、常に一般系になります。

#### ちなみに required_if を使った場合
以下のように書けます。

```php
'nickname' => ['nullable', 'string', 'max:255', 'required_if:name,名無し'],
```

（補足：`string` の指定がある時に `nullable` を付けていないと、空でデータを送る事ができなくなってしまいます）